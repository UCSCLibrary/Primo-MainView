/*
 * From https://github.com/alliance-pcsg/primo-explore-external-search
 *
 * With customizations, all commented below.
 */
angular
  .module('externalSearch', [])
  .value('searchTargets', [])
  .component('prmFacetAfter', {
      bindings: { parentCtrl: '<' },
      controller: ['externalSearchService', function (externalSearchService) {
        externalSearchService.controller = this.parentCtrl
        externalSearchService.addExtSearch()
      }]
  })
  .component('prmPageNavMenuAfter', {
    controller: ['externalSearchService', function (externalSearchService) {
      if (externalSearchService.controller) externalSearchService.addExtSearch()
    }]
  })
  .component('prmFacetExactAfter', {
      bindings: { parentCtrl: '<' },
      /* Customized the template. Removed some div with chips classes. Added target.desc and span wrapper. 
         Changed width/height to 40. */
      template: `
      <div ng-if="name === 'External Search'">
        <div ng-hide="$ctrl.parentCtrl.facetGroup.facetGroupCollapsed">
          <div class="section-content animate-max-height-variable" id="external-search">
            <div ng-repeat="target in targets" aria-live="polite" class="md-chip animate-opacity-and-scale facet-element-marker-local4">
              <div class="md-chip-content layout-row" role="button" tabindex="0">
                <strong dir="auto" title="{{ target.name }}">
                  <a ng-href="{{ target.url + target.mapping(queries, filters) }}" target="_blank">
                    <img ng-src="{{ target.img }}" width="40" height="40"/> {{ target.name }}
                  </a>
                  <span class="desc">{{target.desc}}</span>
                </strong>
              </div>
            </div>
          </div>
        </div>
      </div>`,
      controller: ['$scope', '$location', 'searchTargets', function ($scope, $location, searchTargets) {
        $scope.name = this.parentCtrl.facetGroup.name
        $scope.targets = searchTargets
        let query = $location.search().query
        let filter = $location.search().pfilter
        $scope.queries = Array.isArray(query) ? query : query ? [query] : false
        $scope.filters = Array.isArray(filter) ? filter : filter ? [filter] : false
        /*
         * Customized to replace "University of California" with "UC" in facets
         */
        if ($scope.name == 'institution') {
          // Once the institutions facets load, find them in the document.
          var institutionFacets = document.querySelector('[data-facet-group="institution"]');
          var institutions = null;
          // Facets are created and destroyed in the DOM when the group is toggled.
          // So watch for them to show up on a 1s interval.
          // TODO: Is there a way to catch the toggleFacet method when clicked?
          var institutionsInterval = window.setInterval(function(){
            if (institutions == null || institutions.length == 0) {
              institutions = institutionFacets.getElementsByClassName('text-number-space');
            }
            // If we found them, cycle through the institutions and replace the text as appropriate
            if (institutions.length > 0) {
              for (let oneInst of institutions) {
                oneInst.textContent = oneInst.textContent.replace(',','');
                oneInst.textContent = oneInst.textContent.replace('University of California', 'UC');
                oneInst.title = oneInst.title.replace(',','');
                oneInst.title = oneInst.title.replace('University of California', 'UC');
              }
            }
          }, 1000);
        } // End UC facet customization
      }]
  })
  .factory('externalSearchService', function () {
    return {
      get controller() {
        return this.prmFacetCtrl || false
      },
      set controller(controller) {
        this.prmFacetCtrl = controller
      },
      addExtSearch: function () {
        // Changed this conditional to look for our intended scope.
        if (this.prmFacetCtrl.$stateParams.search_scope == 'Worldcat') {
          this.prmFacetCtrl.facetService.results.unshift({
            name: 'External Search',
            displayedType: 'exact',
            limitCount: 0,
            facetGroupCollapsed: false,
            values: undefined
          })
        }
      }
    }
  })
